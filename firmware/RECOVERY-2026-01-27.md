# Device Recovery and v5.15 Upgrade - 2026-01-27

## Summary

Successfully recovered frozen device and upgraded from v5.8 to v5.15 firmware.

## Initial Problem

- Device frozen on display showing "17:35"
- No serial output
- Multiple firmware iterations had caused instability
- Zone wiping functions were causing e-ink controller freezes

## Root Causes Identified

1. **Zone Wipe Functions with Delays**
   - Functions calling `fillRect` with rapid black/white transitions
   - Even small delays (10ms) caused timing conflicts with e-ink controller
   - Partial refresh operations were unstable

2. **Bootloader Mode Stuck**
   - Device entering bootloader mode (`boot:0x6`) instead of application mode
   - GPIO9 potentially held low during boot
   - Required physical power cycle to resolve

3. **Aggressive Refresh Intervals**
   - Too frequent partial refreshes (every 20s with zone updates)
   - E-ink displays need time between refresh operations

## Recovery Procedure (PROVEN WORKING)

### Step 1: Physical Power Cycle
```bash
⚠️ CRITICAL: Do NOT press BOOT button during power cycle
⚠️ Just plug device straight into computer

1. Unplug USB cable
2. Wait 10 seconds
3. Replug USB (no buttons pressed)
```

### Step 2: Test Serial Communication
```bash
python3 -c "
import serial, time
ser = serial.Serial('/dev/cu.usbmodem14101', 115200, timeout=1)
time.sleep(2)
for i in range(10):
    if ser.in_waiting > 0:
        print(ser.readline().decode('utf-8', errors='ignore'))
    time.sleep(0.5)
ser.close()
"
```

### Step 3: Full Flash Erase (if needed)
```bash
python3 -m esptool --port /dev/cu.usbmodem14101 erase_flash
# Takes ~30 seconds
```

### Step 4: Restore Working Baseline
```bash
cd /Users/angusbergman/PTV-TRMNL-NEW
git show e9644a1:firmware/src/main.cpp > /tmp/main_v5.9.cpp
cp /tmp/main_v5.9.cpp firmware/src/main.cpp

cd firmware
pio run -e trmnl
pio run -t upload -e trmnl

# Physical power cycle after flash
```

### Step 5: Verify Boot
```bash
python3 /Users/angusbergman/PTV-TRMNL-NEW/firmware/tools/live-monitor.py
# Should see: "PTV-TRMNL v5.8/v5.9"
```

## Upgrade to v5.15

Once device was stable on v5.8, upgraded to v5.15:

```bash
cp firmware/src/main.cpp.broken firmware/src/main.cpp
pio run -e trmnl
pio run -t upload -e trmnl
```

### v5.15 Features

1. **Unified Setup Screen**
   - QR code for admin panel access
   - Live NTP time display
   - Setup progress checkboxes
   - Device ID and status

2. **Setup Progress Tracking**
   - `setup_addresses` - Home/work addresses configured
   - `setup_transit_api` - PTV API credentials configured
   - `setup_journey` - Journey route calculated

3. **No Watchdog Timer**
   - Removed in v5.11, maintained in v5.15
   - Prevents crashes from watchdog timeouts

4. **Full Refresh Only**
   - REFRESH_INTERVAL: 30 seconds
   - Only full refreshes (no partial)
   - Prevents e-ink controller freeze issues

5. **NTP Time Sync**
   - Melbourne timezone (UTC+10)
   - Updates every 60 seconds
   - Live time display on all screens

## Key Lessons

### ❌ Don't Do This
- Zone wipe functions with delays during refresh
- Rapid black/white flashing on e-ink displays
- Partial refresh with complex fillRect operations
- Refresh intervals < 20 seconds
- Holding BOOT button during power cycle

### ✅ Do This
- Physical power cycle when frozen
- Full refresh only when debugging display issues
- Minimum 30 second refresh intervals
- Serial monitoring after ANY display code changes
- Plug device straight into computer (no bootloader mode)

## Tools Created

### 1. Live Monitor (`tools/live-monitor.py`)
Real-time serial monitoring with crash detection

### 2. Watchdog Flash (`tools/watchdog-flash.sh`)
Auto-reflash on detected freeze (up to 3 attempts)

### 3. Continuous Monitor (`tools/continuous-monitor.sh`)
Continuous monitoring with auto-recovery on crash/freeze

## Current Status

- ✅ Device running v5.15 firmware
- ✅ Serial communication working
- ✅ WiFi configuration portal active
- ✅ Display initialized (800x480 landscape)
- ⏳ Awaiting WiFi configuration
- ⏳ Awaiting device registration

## Next Steps

1. Connect to WiFi via captive portal (SSID: PTV-TRMNL-Setup)
2. Device will register with server
3. Scan QR code to access admin panel
4. Complete setup steps:
   - Enter home/work addresses
   - Configure PTV API credentials
   - Calculate journey route
5. Device will switch to live dashboard

## Documentation Updated

- ✅ DEVELOPMENT-RULES.md v1.0.25 - Added hard recovery procedure
- ✅ Recovery tools created in firmware/tools/
- ✅ This recovery report (RECOVERY-2026-01-27.md)

## Firmware Files

- `src/main.cpp` - v5.15 (current)
- `src/main.cpp.v58.working` - v5.8 working baseline backup
- `src/main.cpp.broken` - Previous v5.15 attempt (now working!)

## Recovery Success Rate

- Attempts: 3
- Flash cycles: 5
- Physical power cycles: 2
- Final result: ✅ SUCCESS

## Time to Recovery

- Problem identified: 18:45 AEDT
- v5.8 baseline restored: 18:58 AEDT
- v5.15 upgraded: 19:05 AEDT
- Total time: ~20 minutes

---

**Last Updated**: 2026-01-27 19:05 AEDT
**Firmware Version**: v5.15
**Device MAC**: 94:a9:90:8d:28:d0
**Status**: ✅ OPERATIONAL
